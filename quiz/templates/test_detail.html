{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>{{ test.title }} <small class="text-muted">({% trans "–í–æ–ø—Ä–æ—Å" %} {{ current_index }} / {{ total_questions }})</small></h4>
        
        {% if test.time_limit > 0 %}
            <div class="alert alert-danger mb-0 py-1 px-3">
                ‚è≥ <span id="global-timer">--:--</span>
            </div>
        {% endif %}
    </div>

    <form method="post" id="quizForm">
        {% csrf_token %}
        
        <div class="card mb-4 shadow-sm" id="question-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    {% if question.exposure_time == 0 %}
                        <span class="fs-5">
                            {% get_current_language as LANGUAGE_CODE %}
                            {% if LANGUAGE_CODE == 'ru' %}{{ question.text_ru }}
                            {% elif LANGUAGE_CODE == 'kk' %}{{ question.text_kk }}
                            {% else %}{{ question.text_en }}
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="question-text fs-5" style="display:none;">
                            {% get_current_language as LANGUAGE_CODE %}
                            {% if LANGUAGE_CODE == 'ru' %}{{ question.text_ru }}
                            {% elif LANGUAGE_CODE == 'kk' %}{{ question.text_kk }}
                            {% else %}{{ question.text_en }}
                            {% endif %}
                        </span>
                        <span class="memory-hint text-danger fw-bold fs-5">
                            üëÅÔ∏è {% trans "–ó–ê–ü–û–ú–ù–ò–¢–ï –ö–ê–†–¢–ò–ù–ö–£!" %} ({{ question.exposure_time }} c)
                        </span>
                    {% endif %}
                </div>
                <span class="badge bg-secondary">{{ question.get_category_display }}</span>
            </div>

            <div class="card-body">
                {% if question.image %}
                    <div class="text-center mb-3" id="img-cont">
                        <img src="{{ question.image.url }}" class="img-fluid rounded border" style="max-height: 400px;">
                    </div>
                {% endif %}

                <div id="answers-block" {% if question.exposure_time > 0 %}style="display:none"{% endif %}>
                    <div class="list-group">
                        {% for answer in answers_list %}
                            <label class="list-group-item list-group-item-action">
                                <input class="form-check-input me-2" 
                                       type="radio" 
                                       name="selected_answer" 
                                       value="{{ answer.id }}"
                                       {% if current_answer_id == answer.id %}checked{% endif %}>
                                
                                {% get_current_language as LANGUAGE_CODE %}
                                {% if LANGUAGE_CODE == 'ru' %}{{ answer.text_ru }}
                                {% elif LANGUAGE_CODE == 'kk' %}{{ answer.text_kk }}
                                {% else %}{{ answer.text_en }}
                                {% endif %}
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="loading-message" class="alert alert-warning text-center" style="display: none;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <strong>{% trans "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è..." %}</strong>
        </div>

        <div class="d-flex justify-content-between mt-4">
            
            {% if can_go_back %}
                <button type="submit" name="action" value="prev" class="btn btn-outline-secondary px-4">
                    ‚¨ÖÔ∏è {% trans "–ù–∞–∑–∞–¥" %}
                </button>
            {% else %}
                <button type="button" class="btn btn-outline-secondary px-4" disabled>
                    üö´ {% trans "–ù–∞–∑–∞–¥" %}
                </button>
            {% endif %}

            {% if is_last %}
                <button type="submit" name="action" value="finish" id="finishBtn" class="btn btn-success btn-lg px-5">
                    {% trans "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç" %} ‚úÖ
                </button>
            {% else %}
                <button type="submit" name="action" value="next" class="btn btn-primary btn-lg px-5">
                    {% trans "–î–∞–ª–µ–µ" %} ‚û°Ô∏è
                </button>
            {% endif %}
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –ù–ê "–ó–ê–í–ï–†–®–ò–¢–¨" ---
    const form = document.getElementById('quizForm');
    
    form.addEventListener('submit', function(e) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –Ω–∞–∂–∞—Ç–∞ (—á–µ—Ä–µ–∑ submitter)
        const submitter = e.submitter;
        
        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
        if (submitter && submitter.value === 'finish') {
            
            // –ï—Å–ª–∏ —É–∂–µ –Ω–∞–∂–∞—Ç–æ - –æ—Ç–º–µ–Ω—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
            if (submitter.classList.contains('disabled')) {
                e.preventDefault();
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitter.classList.add('disabled'); // –í–∏–∑—É–∞–ª—å–Ω–æ
            submitter.style.pointerEvents = 'none'; // –§–∏–∑–∏—á–µ—Å–∫–∏
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const originalText = submitter.innerHTML;
            submitter.innerHTML = '<span class="spinner-border spinner-border-sm"></span> {% trans "–û–±—Ä–∞–±–æ—Ç–∫–∞..." %}';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('loading-message').style.display = 'block';
            
            // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Å–∞–º–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –¥–µ–ª–∞–ª–∏ e.preventDefault() –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
        }
    });


    // --- 2. –õ–û–ì–ò–ö–ê –ü–ê–ú–Ø–¢–ò ---
    const exposureTime = {{ question.exposure_time }};
    
    if (exposureTime > 0) {
        const imgContainer = document.getElementById('img-cont');
        const answersBlock = document.getElementById('answers-block');
        const textSpan = document.querySelector('.question-text');
        const hintSpan = document.querySelector('.memory-hint');
        
        let timeLeft = exposureTime;
        
        const memoryTimer = setInterval(() => {
            timeLeft--;
            if (hintSpan) hintSpan.innerText = `üëÅÔ∏è {% trans "–ó–ê–ü–û–ú–ù–ò–¢–ï –ö–ê–†–¢–ò–ù–ö–£!" %} (${timeLeft} c)`;
            
            if (timeLeft <= 0) {
                clearInterval(memoryTimer);
                if (imgContainer) imgContainer.style.display = 'none';
                if (hintSpan) hintSpan.style.display = 'none';
                
                answersBlock.style.display = 'block';
                if (textSpan) textSpan.style.display = 'inline';
            }
        }, 1000);
    }

    // --- 3. –û–ë–©–ò–ô –¢–ê–ô–ú–ï–† ---
    {% if test.time_limit > 0 %}
        const testId = "{{ test.id }}";
        const totalMinutes = {{ test.time_limit }};
        const storageKey = `timer_${testId}_end`;
        
        let endTime = localStorage.getItem(storageKey);
        
        if (!endTime || new Date().getTime() > endTime) {
            const now = new Date().getTime();
            endTime = now + (totalMinutes * 60 * 1000);
            localStorage.setItem(storageKey, endTime);
        }

        const timerEl = document.getElementById('global-timer');
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerEl.innerHTML = minutes + ":" + (seconds < 10 ? "0" + seconds : seconds);
            
            if (distance < 0) {
                clearInterval(interval);
                alert("{% trans '–í—Ä–µ–º—è –≤—ã—à–ª–æ!' %}");
                
                // –ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'action';
                input.value = 'finish';
                form.appendChild(input);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                document.getElementById('loading-message').style.display = 'block';
                
                form.submit();
                localStorage.removeItem(storageKey);
            }
        }, 1000);
        
        // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        const finishBtn = document.getElementById('finishBtn');
        if (finishBtn) {
            finishBtn.addEventListener('click', () => localStorage.removeItem(storageKey));
        }
    {% endif %}
});
</script>
{% endblock %}