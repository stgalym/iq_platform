{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>{{ test.title }} <small class="text-muted">({% trans "–í–æ–ø—Ä–æ—Å" %} {{ current_index }} / {{ total_questions }})</small></h4>
        
        {% if test.time_limit > 0 %}
            <div class="alert alert-danger mb-0 py-1 px-3">
                ‚è≥ <span id="global-timer">--:--</span>
            </div>
        {% endif %}
    </div>

    <form method="post" id="quizForm">
        {% csrf_token %}
        
        <div class="card mb-4 shadow-sm" id="question-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    {% if question.exposure_time == 0 %}
                        <span class="fs-5">{{ question.text }}</span>
                    {% else %}
                        <span class="question-text fs-5" style="display:none;">{{ question.text }}</span>
                        <span class="memory-hint text-danger fw-bold fs-5">
                            üëÅÔ∏è –ó–ê–ü–û–ú–ù–ò–¢–ï –ö–ê–†–¢–ò–ù–ö–£! ({{ question.exposure_time }} —Å–µ–∫)
                        </span>
                    {% endif %}
                </div>
                <span class="badge bg-secondary">{{ question.get_category_display }}</span>
            </div>

            <div class="card-body">
                {% if question.image %}
                    <div class="text-center mb-3" id="img-cont">
                        <img src="{{ question.image.url }}" class="img-fluid rounded border" style="max-height: 400px;">
                    </div>
                {% endif %}

                <div id="answers-block" {% if question.exposure_time > 0 %}style="display:none"{% endif %}>
                    <div class="list-group">
                        {% for answer in question.answers.all %}
                            <label class="list-group-item list-group-item-action">
                                <input class="form-check-input me-2" 
                                       type="radio" 
                                       name="selected_answer" 
                                       value="{{ answer.id }}"
                                       {% if current_answer_id == answer.id %}checked{% endif %}
                                       onchange="autoSubmitIfMemory('{{ question.exposure_time }}')"> 
                                       {{ answer.text }}
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            
            {% if can_go_back %}
                <button type="submit" name="action" value="prev" class="btn btn-outline-secondary px-4">
                    ‚¨ÖÔ∏è {% trans "–ù–∞–∑–∞–¥" %}
                </button>
            {% else %}
                <button type="button" class="btn btn-outline-secondary px-4" disabled>
                    üö´ {% trans "–ù–∞–∑–∞–¥" %}
                </button>
            {% endif %}

            {% if is_last %}
                <button type="submit" name="action" value="finish" class="btn btn-success btn-lg px-5">
                    {% trans "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç" %} ‚úÖ
                </button>
            {% else %}
                <button type="submit" name="action" value="next" class="btn btn-primary btn-lg px-5">
                    {% trans "–î–∞–ª–µ–µ" %} ‚û°Ô∏è
                </button>
            {% endif %}
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // 1. –õ–û–ì–ò–ö–ê –ü–ê–ú–Ø–¢–ò (–î–ª—è –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞)
    const exposureTime = {{ question.exposure_time }};
    
    if (exposureTime > 0) {
        const imgContainer = document.getElementById('img-cont');
        const answersBlock = document.getElementById('answers-block');
        const textSpan = document.querySelector('.question-text');
        const hintSpan = document.querySelector('.memory-hint');
        
        let timeLeft = exposureTime;
        
        const memoryTimer = setInterval(() => {
            timeLeft--;
            if (hintSpan) hintSpan.innerText = `üëÅÔ∏è –ó–ê–ü–û–ú–ù–ò–¢–ï –ö–ê–†–¢–ò–ù–ö–£! (${timeLeft} —Å–µ–∫)`;
            
            if (timeLeft <= 0) {
                clearInterval(memoryTimer);
                if (imgContainer) imgContainer.style.display = 'none';
                if (hintSpan) hintSpan.style.display = 'none';
                
                answersBlock.style.display = 'block';
                if (textSpan) textSpan.style.display = 'inline';
            }
        }, 1000);
    }

    // 2. –û–ë–©–ò–ô –¢–ê–ô–ú–ï–† (–ù—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤ localStorage, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–æ—Å—å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ)
    {% if test.time_limit > 0 %}
        const testId = "{{ test.id }}";
        const totalMinutes = {{ test.time_limit }};
        const storageKey = `timer_${testId}_end`;
        
        let endTime = localStorage.getItem(storageKey);
        
        // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω —Å—Ç–∞—Ä—ã–π - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        if (!endTime || new Date().getTime() > endTime) {
            const now = new Date().getTime();
            endTime = now + (totalMinutes * 60 * 1000);
            localStorage.setItem(storageKey, endTime);
        }

        const timerEl = document.getElementById('global-timer');
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerEl.innerHTML = minutes + "–º " + seconds + "—Å";
            
            if (distance < 0) {
                clearInterval(interval);
                alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ!");
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ action=finish –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                const form = document.getElementById('quizForm');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'action';
                input.value = 'finish';
                form.appendChild(input);
                form.submit();
                localStorage.removeItem(storageKey); // –ß–∏—Å—Ç–∏–º
            }
        }, 1000);
        
        // –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å localStorage (–¥–æ–±–∞–≤–∏–º –Ω–∞ –∫–Ω–æ–ø–∫—É finish)
        const finishBtns = document.querySelectorAll('button[value="finish"]');
        finishBtns.forEach(btn => {
            btn.addEventListener('click', () => localStorage.removeItem(storageKey));
        });
    {% endif %}
});
</script>
{% endblock %}